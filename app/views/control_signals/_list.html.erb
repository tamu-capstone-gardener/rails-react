<div class="mt-4">
  <% if control_signals.empty? %>
    <p class="text-sm theme-text-secondary italic">No control signals registered yet.</p>
  <% else %>
    <ul class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 h-auto">
      <% control_signals.each do |signal| %>
        <li class="border border-bg-primary rounded-lg shadow-sm theme-bg-alt flex flex-col justify-between">
          <div class="flex p-4  justify-between items-start flex-0">
            <h3 class="text-xl font-bold theme-text-primary">
              <%= sanitize(signal.label.presence || signal.signal_type) %>
            </h3>
            <%= link_to "Edit", edit_plant_module_control_signal_path(plant_module, signal),
                class: "text-blue-500 hover:underline text-sm" %>
          </div>
          <hr class="border-b-[0.5] border-bg w-full">
          <div class="flex px-4  flex-col justify-start flex-1">
            <p class="theme-text-primary text-sm mt-2" >
              Type: <%= sanitize(signal.mode) %><br/>
              Pulse Length: <%= format_duration(signal.length_ms) || "none" %>
              
            </p>
            <%= turbo_frame_tag "control_execution" do %>
              
              <%= render partial: "control_executions/control_execution", locals: { control_execution: signal.control_executions.order(executed_at: :desc).first }%>
            <% end %>
          </div>
          <div class="px-4">
            <% last_execution = signal.control_executions.order(executed_at: :desc).first %>
            <% if last_execution && signal.mode == "scheduled" %>
              <% scheduled_time = MqttListener.next_scheduled_trigger(signal) %>
              <p class="text-sm theme-text-secondary mt-2">
                <% Rails.logger.info "time.current #{Time.current}; scheduled #{scheduled_time}; scheduled in zone #{scheduled_time.in_time_zone("Central Time (US & Canada)")}"%>
                Next trigger is <%= Time.current - scheduled_time > 0 ? distance_of_time_in_words(Time.current, scheduled_time + 29.hours) : distance_of_time_in_words(Time.current, scheduled_time + 5.hours) %> from now.
              </p>

              <p class="text-sm theme-text-secondary">
                Last triggered <%= time_ago_in_words(last_execution.executed_at) %> ago.
              </p>
            <% elsif last_execution %>
              <p class="text-sm theme-text-secondary">
                Last triggered <%= time_ago_in_words(last_execution.executed_at) %> ago.
              </p>
            <% else %>
              <p class="text-sm theme-text-secondary">Not triggered yet.</p>
            <% end %>
          </div>
          <div class="flex m-4 flex-1 items-end justify-center" data-controller="manual-trigger">
                <%= button_to "Turn on for #{format_duration(signal.length_ms)}",
                              trigger_plant_module_control_signal_path(plant_module, signal),
                              method: :post,
                              params: { toggle: true },
                              class: "btn-secondary px-4 py-2 rounded-lg transition hover:scale-105" %>
            </div>
        </li>
      <% end %>
    </ul>
  <% end %>
</div>
